name: ğŸš€ KOTUKTOPER FULL DIAGNOSTIC
on: workflow_dispatch
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    # 1. CHECKOUT
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 2. JAVA SETUP
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. SYSTEM DIAGNOSTIC
    - name: ğŸ” System Diagnostic
      run: |
        echo "=== SYSTEM INFO ==="
        echo "Java: $(java -version 2>&1 | head -1)"
        echo "CMake: $(cmake --version 2>&1 | head -1 || echo 'Not found')"
        echo "Android SDK: $ANDROID_HOME"
        echo "=== ANDROID SDK PACKAGES ==="
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list | grep -E "platforms|build-tools|cmake" | head -20

    # 4. PROJECT STRUCTURE
    - name: ğŸ“ Project Structure
      run: |
        echo "=== PROJECT FILES ==="
        find . -name "*.gradle" -type f | head -10
        echo "=== BUILD.GRADLE CONTENT ==="
        cat TMessagesProj/build.gradle | head -50
        echo "=== API_KEYS CHECK ==="
        ls -la TMessagesProj/API_KEYS 2>/dev/null && echo "âœ… API_KEYS exists" || echo "âŒ API_KEYS missing"

    # 5. ANDROID SDK INSTALL
    - name: ğŸ“± Install Android SDK
      run: |
        echo "=== INSTALLING ANDROID SDK ==="
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-33"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;33.0.0"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "cmake;3.22.1" || \
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "cmake;3.18.1"

    # 6. CMAKE FIX
    - name: ğŸ› ï¸ Fix CMake Configuration
      run: |
        cd TMessagesProj
        echo "=== FIXING CMAKE ==="
        # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ Ğ²ĞµÑ€ÑĞ¸Ğ¸ CMake
        if grep -q "version \"3.22.1\"" build.gradle; then
          sed -i 's/version "3.22.1"/version "3.18.1"/g' build.gradle
          echo "âœ… Changed CMake to 3.18.1"
        fi
        echo "=== FINAL CMAKE CONFIG ==="
        grep -A 3 -B 3 "cmake" build.gradle

    # 7. GRADLE CONFIG
    - name: âš™ï¸ Gradle Configuration
      run: |
        echo "=== GRADLE PROPERTIES ==="
        cat > gradle.properties << EOF
        org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m
        android.useAndroidX=true
        android.enableJetifier=true
        org.gradle.parallel=true
        org.gradle.daemon=false
        EOF
        cat gradle.properties

    # 8. MAKE EXECUTABLE
    - name: ğŸ”§ Make Gradle Executable
      run: chmod +x gradlew

    # 9. BUILD WITH DETAILED LOGS
    - name: ğŸ—ï¸ Build with Detailed Logging
      run: |
        echo "=== STARTING BUILD ==="
        ./gradlew clean
        ./gradlew assembleDebug --no-daemon --stacktrace --info --scan 2>&1 | tee build.log
        echo "=== BUILD FINISHED ==="

    # 10. APK DETECTION
    - name: ğŸ“¦ APK Detection
      run: |
        echo "=== SEARCHING FOR APK ==="
        find . -name "*.apk" -type f | while read file; do
          echo "ğŸ¯ FOUND APK: $file"
          ls -lh "$file"
        done || echo "âŒ No APK files found"
        
        echo "=== BUILD OUTPUTS ==="
        find . -path "*/build/outputs/*" -name "*.apk" -type f | head -10

    # 11. UPLOAD ARTIFACTS
    - name: ğŸ“¤ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: KotuktoperGram-iOS26-APK
        path: |
          **/build/outputs/apk/**/*.apk
          **/build/outputs/**/*.apk
        retention-days: 30
        if-no-files-found: warn

    # 12. UPLOAD BUILD LOGS
    - name: ğŸ“‹ Upload Build Logs
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: |
          build.log
        retention-days: 7

    # 13. FINAL SUCCESS
    - name: âœ… Build Status
      run: |
        if [ -f "$(find . -name "*.apk" -type f | head -1)" ]; then
          echo "ğŸ‰ SUCCESS: APK built successfully!"
          echo "ğŸ“± Download from Artifacts section"
        else
          echo "âš ï¸ WARNING: Build completed but no APK found"
          echo "ğŸ” Check Build-Logs artifact for details"
        fi

    # 14. LINKS AND REFERENCES
    - name: ğŸ”— Useful Links
      run: |
        echo "=== USEFUL LINKS ==="
        echo "ğŸ“š Telegram FOSS: https://github.com/Telegram-FOSS-Team/Telegram-FOSS"
        echo "ğŸ› ï¸ GitHub Actions: https://docs.github.com/en/actions"
        echo "ğŸ“± Android Build: https://developer.android.com/studio/build"
        echo "â˜• Java Compatibility: https://docs.gradle.org/current/userguide/compatibility.html"
        echo "ğŸ”§ CMake Guide: https://developer.android.com/studio/projects/configure-cmake"

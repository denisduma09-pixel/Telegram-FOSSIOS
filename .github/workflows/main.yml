
name: ğŸš€ KOTUKTOPER ULTIMATE BUILD
on: workflow_dispatch
jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 1. CHECKOUT
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    # 2. JAVA
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. Ğ’Ğ¡Ğ• Ğ¤Ğ˜ĞšĞ¡Ğ« ĞĞ”ĞĞĞ’Ğ Ğ•ĞœĞ•ĞĞĞ
    - name: ğŸ› ï¸ Apply ALL fixes
      run: |
        # Ğ¤Ğ˜ĞšĞ¡ 1: APP_PACKAGE Ğ² TMessagesProj_App
        cd TMessagesProj_App
        sed -i 's/applicationId APP_PACKAGE/applicationId "org.kotuktoper.ios26"/g' build.gradle
        echo "âœ… Fixed APP_PACKAGE"
        
        # Ğ¤Ğ˜ĞšĞ¡ 2: CMAKE Ğ² Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ
        cd ../TMessagesProj
        sed -i '/externalNativeBuild {/,/}/d' build.gradle
        sed -i '/sourceSets.main.jniLibs.srcDirs/d' build.gradle
        echo "âœ… Fixed CMake"
        
        # Ğ¤Ğ˜ĞšĞ¡ 3: gradle.properties Ğ´Ğ»Ñ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸
        cd ..
        echo "org.gradle.jvmargs=-Xmx2048m" > gradle.properties
        echo "âœ… Created gradle.properties"

    # 4. ANDROID SDK
    - name: ğŸ“± Install Android SDK
      run: |
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-33" "build-tools;33.0.0"

    # 5. BUILD
    - name: ğŸ—ï¸ Build APK
      run: |
        chmod +x gradlew
        ./gradlew clean assembleDebug --no-daemon --stacktrace

    # 6. APK LINKS
    - name: ğŸ”— Generate APK Links
      run: |
        echo "=== APK DOWNLOAD LINKS ==="
        APK_FILE=$(find . -name "*.apk" -type f | head -1)
        if [ -f "$APK_FILE" ]; then
          echo "ğŸ“± DIRECT DOWNLOAD: Look in Artifacts section below!"
          echo "ğŸ’¾ FILENAME: $(basename $APK_FILE)"
          echo "ğŸ“ PATH: $APK_FILE"
          echo "ğŸ”„ Refresh page and check Artifacts section"
        else
          echo "âŒ APK not found - check build logs above"
          find . -name "build" -type d | head -5
        fi

    # 7. UPLOAD APK
    - name: ğŸ“¦ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: KotuktoperGram-iOS26
        path: "**/build/outputs/apk/**/*.apk"

    # 8. FINAL SUCCESS
    - name: ğŸ‰ Build Complete
      run: |
        echo "=========================================="
        echo "ğŸš€ KOTUKTOPERGRAM iOS26 BUILD COMPLETE!"
        echo "=========================================="
        echo "ğŸ“± APK: Download from ARTIFACTS section below"
        echo "ğŸ”— Direct: Refresh page â†’ Scroll down â†’ Artifacts"
        echo "ğŸ’¾ File: KotuktoperGram-iOS26.zip"
        echo "ğŸ“¦ Contains: Your APK file"
        echo "=========================================="
